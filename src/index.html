<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>EFS HackFS Prototype</title>
    <link rel="stylesheet" type="text/css" href="app.css">
    <script type="module" src="app.js"></script>
    <script>
        var currentTopic;
        var parentTopic;

        let schemas = {
            "0xddc07ff085923cb9a3c58bf684344b7672881e5a004044e3e99527861fed6435": {
                "name": "topic",
                "display": "Subtopics",
                "properties": [
                    {
                        "name": "name",
                        "display": "Name",
                        "type": "string"
                    }
                ]
            },
            "0xe5abe9a6766fbf5944829bb25cc023cc3c7b3b2326acd9b6047cc019960e0b01": {
                "name": "property",
                "display": "Properties",
                "properties": [
                    {
                        "name": "name",
                        "display": "Name",
                        "type": "string"
                    },
                    {
                        "name": "value",
                        "display": "Value",
                        "type": "string"
                    },
                    {
                        "name": "mediaType",
                        "display": "Media Type",
                        "type": "string"
                    },
                    {
                        "name": "Offchain",
                        "display": "Is Offchain? (IPFS)",
                        "type": "bool"
                    },
                ]
            }
        };

        const loadTopic = async (topicId) => {
            //history.pushState({topicId: topicId}, "", "/" + topicId);
            document.getElementById("topicPath").innerHTML = await getParentTopics(topicId);
            document.getElementById("0xddc07ff085923cb9a3c58bf684344b7672881e5a004044e3e99527861fed6435List").innerHTML = await loadTopicList(topicId);

            let properties = await loadProperties(topicId);
            let table = document.createElement("table");
            properties.forEach(property => {
                let row = document.createElement("tr");

                let cell1 = document.createElement("td");
                cell1.textContent = property.decodedDataJson[0].value.value;
                cell1.classList.add("propName");
                row.appendChild(cell1);

                let cell2 = document.createElement("td");
                cell2.textContent = property.decodedDataJson[1].value.value;
                cell2.classList.add("propValue");
                row.appendChild(cell2);

                table.appendChild(row);
            });
            document.getElementById("0xe5abe9a6766fbf5944829bb25cc023cc3c7b3b2326acd9b6047cc019960e0b01List").innerHTML = "";
            document.getElementById("0xe5abe9a6766fbf5944829bb25cc023cc3c7b3b2326acd9b6047cc019960e0b01List").appendChild(table);

            document.getElementById("0x3969bb076acfb992af54d51274c5c868641ca5344e1aacd0b1f5e4f80ac0822fList").innerHTML = await getMessagesForTopic(topicId, 3);

            currentTopic = topicId;
        }

        const search = async () => {
            var topic = document.getElementById("search").value;
            loadTopic(topic);
        }

        const newTopic = async () => {
            var topicName = document.getElementById("newTopic").value;
            createNewTopic(topicName, currentTopic);
        }

        const openAttestationEditor = async (schemaId) => {
            var attestationEditor = document.createElement("div");
            attestationEditor.innerHTML = "<h3>Attestation Editor</h3><p>Attestation Schema: " + schemaId + "</p><p>Attestation Data: <input id='attestationData' type='text'></p><button onclick='callCreateAttestation(\"" + schemaId + "\")'>Submit</button>";
            document.getElementById(schemaId + "List").prepend(attestationEditor);
        }

        const callCreateAttestation = async (schemaId) => {
          let data = {};
          data.topicName = document.getElementById("attestationData").value;
          createAttestation(schemaId, data, currentTopic);
        }

    </script>
  </head>
  <body onload="loadTopic('0x6e4851b1ee4ee826a06a4514895640816b4143bf2408c33e5c1263275daf53ce');">
    <div id="topicHeader">
      <h1 id="topicPath">EFS Topic Browser</h1>
      <p>Editor: <input id="editorInput" type="text"> <button id="Editor">View</button> Go to topic: <input id="search" type="text"> <button id="go" onclick="search();">Go</button> <input id="newTopic" type="text"> <button id="newTopicButton" onclick="newTopic();">Add Topic</button></p>
    </div>
    <div id="0xddc07ff085923cb9a3c58bf684344b7672881e5a004044e3e99527861fed6435View" class="schemaView">
      <h2>Subtopics <span class="createAttestation">[<a href="#" onclick="openAttestationEditor('0xddc07ff085923cb9a3c58bf684344b7672881e5a004044e3e99527861fed6435')">Create New</a>]</span></h2>
      <div id="0xddc07ff085923cb9a3c58bf684344b7672881e5a004044e3e99527861fed6435List"></div>
    </div>
    <div id="0xe5abe9a6766fbf5944829bb25cc023cc3c7b3b2326acd9b6047cc019960e0b01View" class="schemaView">
      <h2>Properties <span class="createAttestation">[<a href="#" onclick="openAttestationEditor('0xe5abe9a6766fbf5944829bb25cc023cc3c7b3b2326acd9b6047cc019960e0b01')">Create New</a>]</span></h2>
      <div id="0xe5abe9a6766fbf5944829bb25cc023cc3c7b3b2326acd9b6047cc019960e0b01List"></div>
    </div>
    <div id="0x3969bb076acfb992af54d51274c5c868641ca5344e1aacd0b1f5e4f80ac0822fView" class="schemaView">
      <h2>Messages <span class="createAttestation">[Create New]</span></h2>
      <div id="0x3969bb076acfb992af54d51274c5c868641ca5344e1aacd0b1f5e4f80ac0822fList"></div>
    </div>
  </body>
</html>